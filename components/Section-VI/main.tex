\newpage
\section{\textbf{THIẾT KẾ CƠ SỞ DỮ LIỆU}}

\subsection{Thiết kế sơ đồ E-R}
Dựa trên các yêu cầu phân tích, hệ thống bao gồm các thực thể chính: Người dùng (Users), Ví (Wallets), Giao dịch (Transactions) và Phiên chat (ChatSessions). Mối quan hệ giữa chúng được mô tả như sau:
\begin{itemize}
    \item Một \textbf{User} có duy nhất một \textbf{Wallet}.
    \item Một \textbf{Wallet} có thể thực hiện nhiều \textbf{Transactions}.
    \item Một \textbf{User} có thể có nhiều \textbf{ChatSessions} với AI.
\end{itemize}

\subsection{Thiết kế chi tiết Collection (MongoDB)}

\textbf{1. Users (Người dùng)}
Lưu trữ thông tin cá nhân và tài khoản của sinh viên và quản trị viên.

\begin{table}[H]
\centering
\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{3cm}|p{3cm}|p{2cm}|p{6cm}|}
\hline
\textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
\hline
\_id & ObjectId & Có & Khóa chính \\
\hline
studentCode & String & Có & Mã số sinh viên (Unique) \\
\hline
fullName & String & Có & Họ và tên đầy đủ \\
\hline
email & String & Có & Email trường cấp \\
\hline
password & String & Có & Mật khẩu đã mã hóa (bcrypt) \\
\hline
phoneNumber & String & Có & Số điện thoại liên lạc \\
\hline
role & String & Có & Vai trò: "STUDENT" hoặc "ADMIN" \\
\hline
isActive & Boolean & Có & Trạng thái kích hoạt tài khoản \\
\hline
createdAt & Date & Có & Thời gian tạo \\
\hline
\end{tabular}
\caption{Cấu trúc Collection Users}
\end{table}

\textbf{2. Wallets (Ví điện tử)}
Lưu trữ thông tin số dư và trạng thái ví của sinh viên.

\begin{table}[H]
\centering
\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{3cm}|p{3cm}|p{2cm}|p{6cm}|}
\hline
\textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
\hline
\_id & ObjectId & Có & Khóa chính \\
\hline
userId & ObjectId & Có & Tham chiếu đến Users \\
\hline
balance & Number & Có & Số dư hiện tại (VNĐ) \\
\hline
currency & String & Có & Đơn vị tiền tệ (Default: "VND") \\
\hline
status & String & Có & Trạng thái: "ACTIVE", "LOCKED" \\
\hline
lastTransaction & Date & Không & Thời gian giao dịch gần nhất \\
\hline
updatedAt & Date & Có & Thời gian cập nhật số dư cuối cùng \\
\hline
\end{tabular}
\caption{Cấu trúc Collection Wallets}
\end{table}

\textbf{3. Transactions (Giao dịch)}
Lưu trữ lịch sử nạp tiền và thanh toán.

\begin{table}[H]
\centering
\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{3cm}|p{3cm}|p{2cm}|p{6cm}|}
\hline
\textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
\hline
\_id & ObjectId & Có & Khóa chính \\
\hline
walletId & ObjectId & Có & Tham chiếu đến Wallets \\
\hline
type & String & Có & Loại GD: "DEPOSIT\_MOMO", "PAYMENT\_NFC" \\
\hline
amount & Number & Có & Số tiền giao dịch \\
\hline
status & String & Có & Trạng thái: "PENDING", "SUCCESS", "FAILED" \\
\hline
description & String & Có & Nội dung giao dịch \\
\hline
metadata & Object & Không & Dữ liệu chi tiết (Mã GD MoMo, ID thiết bị POS) \\
\hline
createdAt & Date & Có & Thời gian thực hiện \\
\hline
\end{tabular}
\caption{Cấu trúc Collection Transactions}
\end{table}

\textbf{4. ChatSessions (Hội thoại AI)}
Lưu trữ lịch sử trò chuyện giữa sinh viên và trợ lý ảo Gemini để duy trì ngữ cảnh.

\begin{table}[H]
\centering
\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{3cm}|p{3cm}|p{2cm}|p{6cm}|}
\hline
\textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
\hline
\_id & ObjectId & Có & Khóa chính \\
\hline
userId & ObjectId & Có & Tham chiếu đến Users \\
\hline
messages & Array & Có & Mảng các tin nhắn (role: user/model, content) \\
\hline
summary & String & Không & Tóm tắt nội dung hội thoại \\
\hline
createdAt & Date & Có & Thời gian bắt đầu \\
\hline
updatedAt & Date & Có & Thời gian tin nhắn cuối cùng \\
\hline
\end{tabular}
\caption{Cấu trúc Collection ChatSessions}
\end{table}

\newpage
\subsection{Mô hình quan hệ (Schema Diagram)}
Hình dưới đây mô tả mối quan hệ tham chiếu giữa các collection trong cơ sở dữ liệu MongoDB.

\begin{figure}[H]
    \centering
    % Placeholder cho sơ đồ ER/Schema
    \fbox{\begin{minipage}{0.9\textwidth}
        \centering
        \vspace{2cm}
        \textbf{[SƠ ĐỒ QUAN HỆ CƠ SỞ DỮ LIỆU - MONGODB SCHEMA]} \\
        User (1) --- (1) Wallet \\
        Wallet (1) --- (n) Transactions \\
        User (1) --- (n) ChatSessions
        \vspace{2cm}
    \end{minipage}}
    \caption{Sơ đồ quan hệ cơ sở dữ liệu}
    \label{fig:db_schema}
\end{figure}
